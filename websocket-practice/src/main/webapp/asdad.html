<html lang="en">

<head>
    <link rel="icon"
          type="image/x-icon"
          href="images/favicon.ico?">
    
    <title>ChatApp</title>
</head>

<body>
<div class="row">
    <div class="c">
        <label for="from"></label>
        <input id="from"
               type="text"
               placeholder="Enter nickname"/>
    </div>

    <br>

    <div>
        <button id="connect"
                onclick="connect();">
            Connect
        </button>

        <button id="disconnect"
                disabled="disabled"
                onclick="disconnect();">
            Disconnect
        </button>
    </div>

    <br>

    <div id="conversationDiv">
        <label for="text"></label>
        <input id="text"
               type="text"
               placeholder="Write a message.."/>

        <button id="sendMessage"
                onclick="sendMessage();">
            Send
        </button>

        <p id="response"></p>
    </div>
</div>

</body>
</html>

<script src="js/sockjs.js"></script>
<script src="js/stomp.js"></script>
<script src="js/jquery.js"></script>
<script src="js/bootstrap.js"></script>
<script src="css/bootstrap.css"></script>
<script type="text/javascript">
    const CONSTANT = {
        DESTINATION: {
            CHAT: "/app/chat"
        },
        
        ENDPOINT: {
            CHAT: "/chat"
        },

        TOPIC: {
            CHAT_MESSAGES: "/topic/chat-messages"
        },
    }
    
    
    let stompClient = null;

    function setConnected(isConnected) {
        document.getElementById('connect').disabled = isConnected;
        document.getElementById('disconnect').disabled = !isConnected;
        document.getElementById('conversationDiv').style.visibility = isConnected ? 'visible' : 'hidden';
        document.getElementById('response').innerHTML = '';
    }

    function connect() {
        stompClient = Stomp.over(new SockJS(CONSTANT.ENDPOINT.CHAT));

        stompClient.connect({}, function (frame) {
            setConnected(true);

            console.log('Connected: ' + frame);

            stompClient.subscribe(CONSTANT.TOPIC.CHAT_MESSAGES, function (messageOutput) {
                showMessageOutput(JSON.parse(messageOutput.body));
            });
        });
    }

    function disconnect() {
        if (stompClient != null) {
            stompClient.disconnect();
        }

        setConnected(false);

        console.log("Disconnected");
    }

    function sendMessage() {
        let from = document.getElementById('from').value;
        let text = document.getElementById('text').value;

        console.log(from)

        stompClient.send(CONSTANT.DESTINATION.CHAT, {},
            JSON.stringify(
                {
                    'from': from,
                    'text': text
                }
            )
        );
    }

    function showMessageOutput(messageOutput) {
        let response = document.getElementById('response');
        let p = document.createElement('p');

        p.style["wordWrap"] = 'break-word';

        let text = document.createTextNode(
            messageOutput.from
            + ": "
            + messageOutput.text
            + " (" + messageOutput.time
            + ")"
        );

        p.appendChild(text);

        response.appendChild(p);
    }
</script>